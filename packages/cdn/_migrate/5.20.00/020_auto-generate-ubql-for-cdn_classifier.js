module.exports = generateUbqlForCdnClassifier

/**
 * @param {object} params
 * @param {SyncConnection} params.conn
 */
function generateUbqlForCdnClassifier ({ conn }) {
  console.log('Migration script start: %s', __filename)

  const entity = 'cdn_classifier'

  console.info(
    `  It will update all "${entity}.ubql" attribute from autogenerated ubql using "UB.Repository"`
  )

  console.log(`      Loading entries of ${entity}...`)
  const entries = conn.Repository(entity).attrs('ID', 'code', 'orderByAttr').select()
  console.log(`      ${entries.length} entries`)

  entries.forEach(({ ID, code, orderByAttr }) => {
    const generatedUbql = JSON.stringify(
      conn.Repository('cdn_classifieritem')
        .attrs('ID', 'code', 'name')
        .where('classifierID', '=', ID)
        .orderBy(orderByAttr)
        .ubql()
    )

    conn.query({
      entity,
      method: 'update',
      execParams: {
        ID,
        ubql: generatedUbql
      },
      __skipOptimisticLock: true
    })
    console.info('    Set ubql="%s" for "%s"', generatedUbql, code)
  })

  console.log('Migration script finish: %s', __filename)
}
