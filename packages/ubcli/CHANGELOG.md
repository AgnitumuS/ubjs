# Change Log
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/)
and this project adheres to [Semantic Versioning](http://semver.org/).

## [Unreleased]
### Added

### Changed

### Deprecated

### Removed

### Fixed

## [5.6.5] - 2020-08-19
## [5.6.4] - 2020-08-19
### Deprecated
 - `ubcli prepareGZIP` command is removed (obsolete). For a production environment `generateNgingCfg & linkStatic`
  should be used instead.

## [5.6.3] - 2020-07-28
## [5.6.2] - 2020-07-26
## [5.6.1] - 2020-07-19
## [5.6.0] - 2020-07-16
### Fixed
 - `ubcli generateNginxCfg`: in case `httpServer.host` is a Unix Domain Socket (unix:/path/to/file.socket) move
 it to nginx upstream config as is (without trying to url.parse it)
 - `ubcli generateNginxCfg`: adds `Access-Control-Allow-Origin` for internal location in case CORS is allowed and
 client request contains `Origin:` header. Without these changes internal location ignores `Access-Control-*` headers
 generated by server, so cross origin clients can't retrieve a document content.   


## [5.5.21] - 2020-07-15
## [5.5.20] - 2020-07-08
## [5.5.19] - 2020-07-01
### Fixed
 - prevent generation of many-to-many table (storage for attributes of "Many" type) twice in case `associationManyData`
  property starts with entity name 

## [5.5.18] - 2020-06-30
## [5.5.17] - 2020-06-21
## [5.5.16] - 2020-06-15
## [5.5.15] - 2020-06-15
## [5.5.14] - 2020-06-14
### Fixed
 - `ubcli initialize` command: added missed `/` in file path inside error message "File ... does not export function" 

## [5.5.13] - 2020-06-09
### Changed
- `linkStatic` command now does not start ub server and does not require `user` and `password` command line parameters
  anymore, but still requires `ubConfig.json` file.

## [5.5.12] - 2020-05-25
## [5.5.11] - 2020-05-22
## [5.5.10] - 2020-05-17
## [5.5.9] - 2020-05-13
### Added
 - detailed explanation of database creation in initDB - see https://unitybase.info/api/server-v5/module-initDB.html
 for tips how to create a database manually

## [5.5.8] - 2020-05-06
## [5.5.7] - 2020-04-24
## [5.5.6] - 2020-04-10
## [5.5.5] - 2020-03-30
## [5.5.4] - 2020-03-20
## [5.5.3] - 2020-03-17
## [5.5.2] - 2020-03-09
## [5.5.1] - 2020-03-04
### Added
 - `ubcli meta-tr` will transform entity level mapping to object (missed in prev. version)
 - `ubcli meta-tr` will fix mapping dialect AnsiSql -> AnsiSQL (many such mistakes in old UB projects)

### Fixed
 - `ubcli meta-tr` will show line and column in case of invalid meta file JSON

## [5.5.0] - 2020-02-29
### Changed
 - use `model.realPath` in `ubcli` scripts instead of calculating absolute models path manually
   
## [5.4.21] - 2020-02-23
### Fixed
 - `npx ubcli generateNginxCfg` - expires 600; should be added to `/clientRequire`, `/models` and `/static` locations
  to prevent Google Chrome cache heuristic to take a `js` files from a disk cache even if they modified on server 

## [5.4.20] - 2020-02-18
### Changed
 - ESLint errors and warnings fixed (no functional changes)

## [5.4.19] - 2020-02-14
### Added
 - new command line option `-su` (skipUndocumented) for `ubcli generateDoc`. If passed then undocumented API methods
 will be excluded from documentation.
 Example: `npx ubcli generateDoc -u admin -p admin -su`
  
### Fixed
  - `npx ubcli generateDoc` now works on Windows platform 

## [5.4.18] - 2020-02-13
## [5.4.17] - 2020-02-10
### Added
 - `npx ubcli generateDoc` now understand entity level method documentation in format
```
/**
 * Forms and returns array of dynamical entity's roles
 * @param {ubMethodParams} runparams
 * @return {Boolean}
 */
me.addAllDynRoles = function(ctx) {...}
```
in addition to
```
/**
 * Forms and returns array of dynamical entity's roles
 * @param {ubMethodParams} runparams
 * @return {Boolean}
 * @memberOf contr_contractdoc_ns.prototype
 * @memberOfModule @docflow/contr
 * @published
 */
function addAllDynRoles(ctx) {...}
me.addAllDynRoles = addAllDynRoles
```
 - `npx ubcli generateDoc` will look into 1 level depth sub-folders of model folders for sources
 - `npx ubcli generateDoc` will skip 'public', '_migration' and '_autotest' folders while generating jsdoc snippets
  
## [5.4.16] - 2020-02-08
### Added
 - `npx ubcli generateDoc` command will parse a domain models jsdoc and adds a entity methods description and
   parameters into documentation

## [5.4.15] - 2020-02-03
## [5.4.14] - 2020-01-31
## [5.4.13] - 2020-01-17
## [5.4.12] - 2020-01-11
## [5.4.11] - 2019-12-27
## [5.4.10] - 2019-12-20
## [5.4.9] - 2019-12-19
### Fixed
- DDL generation for PostgreSQL 12 and UP; DDL generator now use `pg_get_constraintdef(oid)` for getting check constraints instead of obsolette `pg_constraint.consrc`

## [5.4.8] - 2019-12-18
## [5.4.7] - 2019-12-17
## [5.4.6] - 2019-12-17
### Changed
 - `ubcli generateNginxCfg` will force adding redirect 80 -> 443 in case external URL is https

## [5.4.5] - 2019-12-12
### Added
 - `ubcli linkStatic` can generate cmd script if executed under Windows

## [5.4.4] - 2019-12-11
### Fixed
 - `ubcli generateNginxCfg` will always use `/` in staticRoot locations path independently of platform
 
## [5.4.0] - 2019-11-21
### Added
 - new command `ubcli linkStatic`: creating folder with all static assets (models, modules) what should be available
   for client using `/clientRequire` and `/models` endpoints. Such folder can be served by nginx as a static folder.
   See tutorial [Serving static assets by nginx](https://unitybase.info/api/server-v5/tutorial-reverse_proxy_nginx.html#serving-static-assets-by-nginx)
   for details
 - `npx ubcli generateNginxCfg` will add a location `/statics` what points to `httpServer.inetPub` folder
 - `npx ubcli generateNginxCfg` will add a locations `/clientRequire` and `/models` to nginx config
   in case reverseProxy.serveStatic is true (default)  
   
### Fixed
 - prevent expose a package to client by adding `"config": {"ubmodel": {} }` into package.json
 
## [5.3.42] - 2019-09-17
### Fixed
 - Oracle DDL generator - do not wrap enum group into quotes when update a value for enum column from `null` to `not null`
 
## [5.3.41] - 2019-09-16
### Fixed
 - Oracle DDL generator - do not wrap enum group into quotes when update a value for enum column with `not null`
   
## [5.3.38] - 2019-08-28
### Changed
 - speed up command `ubcli checkStoreIntegrity` by removing `attribute not null` expression from SQL and 
 check attachment is exist in JS

## [5.3.37] - 2019-08-27
### Added
 - `ubcli generateDoc` will add's API methods available for entities; HTML output is formatted using bootstrap  

## [5.3.36] - 2019-08-23
### Fixed
 - DDL generator will correctly add a JSON columns with `allowNull: false` and without default value;
 For such case estimated value for updating existed rows is set to `{}`
 
## [5.3.35] - 2019-08-20
### Fixed
 - DDL generator: in case database connection does not contains entities for DDL generation (all entities is marked as External for example)
 ubcli generateDDL will skip loading of DB metadata for such connections.
 This fix issue for read-only Oracle connections in which DDL generator try to create a stored procedure and speed up generation for other RDBMS    


## [5.3.30] - 2019-07-23
### Added
 - new command `ubcli checkStoreIntegrity` for validate blobStore consistency by checking equality of the
 md5 checksum stored in the database with actual file MD5
```bash
npx ubcli checkStgoreIntegrity -u ... -p ... -entity tst_document -attribute fileStoreSimple
``` 
see `npx ubcli checkStoreIntegrity --help` for details
   

## [5.3.29] - 2019-07-22
### Fixed
 - in case executed for folder `ubcli meta-tr` will skip files what contains meta in name but not a metafile itself (bla-bla.metadata for example)

## [5.3.28] - 2019-07-17
### Changed
 - `MSSQL2012` dialect will use `NVARCHAR(MAX)` instead of `NVARCHAR(4000)` for JSON 

## [5.3.22] - 2019-06-20
### Added
 - Now `meta-tr` supports path to file or directory contained `*.meta*` files as parameter 
 ```
 npx ubcli meta-tr -m C:\myFolder\myApp\models\tstModel
 ```

## [5.3.19] - 2019-05-29
### Fixed
 - in case ID attribute explicitly specified in meta file and mapped to another attribute whose isUnique===false
  then the primary key for such an entity is not created 

## [5.3.12] - 2019-04-04
### Added
 - support for Oracle Text and CTXCAT indexes (require Oracle Text to be enabled - see https://docs.oracle.com/cd/E11882_01/install.112/e27508/initmedia.htm#DFSIG269)

## [5.3.11] - 2019-03-11
### Fixed
 - `npx ubcli meta-tr` command now work correctly. Meta content encoding before using `JSON.parse()` was fixed

### Added
 - `npx ubcli generateNginxCfg` will add a Clickjacking/sniffing/XSS protections for /app internal URL.
 This protect both login page (custom and build-in) form such kinds of attacks. 
 - new option `-t` or `tests` for `npx ubcli autotest` allows to specify a comma separated tests files to execute
 
## [5.3.0] - 2018-12-12
### Changed
 - `generateDDL` command now work under `root` system account and can be executed only locally.
 `-u` and `-p` command line switches not used anymore.
```
npx ubcli generateDDL -cfg $UB_CFG -autorun
```
  Since `root` auth schema do not fire `Session.on('logon')` event developers can remove conditions for
  DDL generation (when database is not fully created yet) 
```
 if (Session.userID === UBA_COMMON.USERS.ADMIN.ID) return
```
  from `Session.on('logon')` handlers
  
## [5.2.6] - 2018-12-09
### Added
 - `generateNginxCfg` now support `reverseProxy.remoteConnIDHeader` and in case
  it is not empty adds a `proxy_set_header {{remoteConnIDHeader}} $connection;`
  section to nginx config

### Changed
 - in case invalid command is passed to `ubcli` human readable error will be shown

## [5.2.4] - 2018-12-04
### Changed
 - **BREAKING** change default floating scale precision from 4 to 6
 - `initDB` will ignore `-host` parameter (always used a host from config)
 - `initDB` will ignore `-u` parameter (always used a `admin`)
 - `initDB` will set a default password for user `admin` as specified in `-p` command line parameter.
   Previous implementation always set the `admin` password to `admin`  
 
### Added 
 - DDl generator will use floating scale precision from UBDomain.FLOATING_SCALE_PRECISION constant
 (6 by default)  

## [5.2.2] - 2018-11-22
### Fixed
 - `npx ubcli generateNgingCfg` will generate correct `ssl_ciphers` list
 - `npx ubcli generateNgingCfg` will add `listen 443 ssl;` in case external URL is HTTPS
 
### Changed
 - `npx ubcli generateNgingCfg` will enable **HTTP 2.0** in case external URL is HTTPS  
 - `ln -s` sample for nginx config will change config file name to the site host name. 
   This help to manage a big productions configs.  

## [5.2.0] - 2018-11-19
### Added 
 - `npx ubcli` will display short commands descriptions in addition to command names
 - new command `meta-tr` added to `ubcli` to be used to transform *.meta attributes from Object to Array as
 required by latest Entity JSON schema:
```bash
 npx ubcli meta-tr -m /home/mpv/dev/ubjs/apps/autotest/models/TST/tst_document.meta
```   
  
## [5.1.4] - 2018-10-18
### Fixed 
 - `ubcli initDB -drop` for SQLite3 will also delete possible WAL logs (-wal and -shm files)
 - `ubcli generateNginxConfig` will add `expire` and `Cache-Control` for
  internal locations to force browser to check resources on server is actual. For DEV modes
  set expires to 0 in `../app` internal location

### Changed
 - `ubcli generateNginxConfig` now use `httpServer.externalURL` from server config for
 generation of nginx proxy server_name.
  - many improvements to nginx config generated `ubcli generateNginxConfig` - 
  **we recommend to recreate reverse proxy configs** after upgrading ub server and all packages.

## [5.1.2] - 2018-10-05
### Fixed 
 - [unitybase/ubjs#15] - Postgre DDl generator must use `SELECT nextval('${sequenceObj}')`
 for sequence incrementing

## [5.1.0] - 2018-10-03
### Added
- `ubcli generateDDL` now support Json type attributes

### Fixed
 - database initialization scripts will create DDL for uba_els.code & uba_els.ruleType 
 as NVARCHAR instead of VARCHAR as in current metadata
 - return back creation of sequences for cached entities (lost during ub1.12 -> ub5 migration).
  This patch speed up getting of cached entities cache version (especially for large tables)
   and fix [unitybase/ubjs#15] for all DB except SQLite3 

## [5.0.40] - 2018-09-07
### Fixed
- `ubcli generateDDL` will skip DDL generation for entities without `mStorage` mixin [unitybase/ubjs#11]
- When create a new DB using `ubcli initDB -create` command, the created user for
  SQL Server database have correct default schema `dbo` [unitybase/ubjs#12]

## [5.0.30] - 2018-07-27
### Fixed
- fixed [unitybase/ubjs#9] DDL SQLite3 "Error: this.DDL.dropColumn.push is not a function"

## [5.0.29] - 2018-07-25
### Fixed
- fixed [unitybase/ubjs#7] - missing genCodeDropPK in SQL Server DDl generator

## [5.0.28] - 2018-07-21
### Fixed
- Fixed [unitybase/ubjs#5] - DDL generation will drop and re-create indexes of columns if column type is changed

## [5.0.19] - 2018-06-21
### Fixed
- PostgreSQL DDL generator will ignore functional ("func") index definition in `dbExtensions`
 section (should be applied only for Oracle as documented)
- PostgreSQL DDL generator will generate single-quoter string for estimation update of newly
 added not null attributes of string type

## [5.0.18] - 2018-06-06
### Fixed
- `ubcli createStore` will create temp path even if it is relative.
 In this case we consider path is relative to config path

## [5.0.16] - 2018-05-31
### Fixed
- fix retrieve foreign key metadata from PostgreSQL (BOOL column type not handled properly by ZEOS 7.2)

## [5.0.9] - 2018-05-11
### Fixed
 - createCodeInsightHelper will ignore models with "_public_only_" paths

## [5.0.7] - 2018-05-06
### Changed
 - stubs created by `createCodeInsightHelper` now include documentation specified in entity meta files

## [5.0.6] - 2018-04-29
### Changed
- createCodeInsightHelper command now generate stubs using ES6 syntax
- createCodeInsightHelper create [entityCode]_ns stub class for each entity
  and define e global variable [entityCode] = new [entityCode]_ns()

## [1.3.2] - 2018-04-15
### Fixed
- correctly generate a check constraints defined in `dbExtensions` section of entity metadata

## [1.2.7] - 2018-02-01
### Fixed 
- PostgreSQL DDL generator: DROP INDEX script syntax

## [1.2.3] - 2017-11-28
### Fixed
- Database metadata for PostgreSQL now loaded for a current_schema instead of current_user
- Added missed ; in the end of DDL script block

## [1.2.0] - 2017-10-23
### Added
- DDL generation for PostgreSQL including latest PostgreSQL 10 release. Required UB >= 4.1.0beta.8

## [1.0.41] - 2017-10-07
### Changed
- ublci `createCodeInsightHelper` command now generate entities stubs using **standard JS** code style

## [1.0.36] - 2017-09-12
### Added
- maximum database identifier length (table/constraint names etc) now depend on dialect. 30 for oracle, 116 for SQL Server

## [1.0.34] - 2017-08-28
### Fixed
- prepareGZIP command now work properly (adding @unitybase/compressors dependency)


## [1.0.28] - 2017-05-18
### Added
- ability to create a empty database for non-default connection using `-conn` initDB parameter: `ubcli initDB -conn connectionName -create -drop`. 

### Fixed
- show a connection name during database drop/create operations

## [1.0.26] - 2017-04-28
### Added

### Fixed
- DDL generator will skip attributes mapped to another existed attribute
