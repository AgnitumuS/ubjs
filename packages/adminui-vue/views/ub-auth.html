<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; object-src 'none'; base-uri 'none'; style-src 'self' 'unsafe-inline' data:; font-src 'self' data:; frame-src 'none'; img-src 'self' https://unitybase.info data:;">
  <!-- import CSS -->
  <!-- normalize browser CSS i.e. button should have the same font-family as body -->
  <link rel="stylesheet" href="/clientRequire/font-awesome/css/font-awesome.min.css"/>
  <script src="/clientRequire/lodash/lodash.min.js"></script>
  <script src="/clientRequire/@unitybase/ub-pub/dist/ub-pub.min.js"></script>
  <script src="/models/adminui-vue/dist/adminui-vue.min.js"></script>
</head>
<body>
<style>
  #auth-page {
    width: 100%;
    height: 100%;
    justify-content: center;
    text-align: center;
    align-items: center;
  }
  #auth-page input[type="file"] {
      display: none;
  }
  .auth-page--left {
      text-align: left;
  }
  .auth-page__header {
    padding: 2rem 0 0 0;
    font-size: 1.5rem;
    font-weight: 100;
  }

  .auth-page__cert-info {
    text-align: left;
    line-height: 1.25rem;
  }

  .auth-page__container {
    width: 300px;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  .auth-page__logo-container {
    max-width: 210px;
    margin: 2rem auto 1rem;
    height: 3rem;
  }
  .auth-page__logo {
    max-height: 3rem;
    max-width: fit-content;
  }

  .auth-page__tooltip {
    position: absolute;
    margin-left: 140px;
  }
</style>


<template id="pwdChangeTpl">
    <el-form :model="changePwd" size="mini" ref="changePwdForm"
             :rules="changePwdRules" @submit.native.prevent label-width="45%">
        <div v-if="changePwd.changedSuccessfully">
            <p v-html="$ut('passwordChangedSuccessfully')"></p>
            <el-button type="primary" plain style="min-width: 8rem" @click="doLogout">
                {{ $ut('logout') }}
            </el-button>
        </div>
        <div v-else>
            <p v-html="$ut('Your password is expired. Please change password')"></p>
            <el-tooltip placement="bottom" effect="light">
                <i class="auth-page__tooltip fa fa-question-circle-o"></i>
                <div slot="content" v-html="$ut('passwordRecommendation')"></div>
            </el-tooltip>
            <el-form-item class="auth-page--left" :label="$ut('User')">
                <span>{{changePwd.user}}</span>
            </el-form-item>

            <el-form-item :label="$ut('OldPassword')" prop="oldPwd">
                <el-input :placeholder="$ut('EnterOldPassword')" v-model="changePwd.oldPwd" @keyup.enter.native="doChangePassword" type="password" autocomplete="off">
                </el-input>
            </el-form-item>
            <el-form-item :label="$ut('NewPassword')" prop="newPwd">
                <el-input :placeholder="$ut('EnterNewPassword')" v-model="changePwd.newPwd" @keyup.enter.native="doChangePassword" type="password" autocomplete="off">
                </el-input>
            </el-form-item>
            <el-form-item :label="$ut('RetypePassword')" prop="newPwd2">
                <el-input :placeholder="$ut('RetypePassword')" v-model="changePwd.newPwd2" @keyup.enter.native="doChangePassword" type="password" autocomplete="off">
                </el-input>
            </el-form-item>
            <el-button type="primary" plain style="min-width: 8rem" @click="doChangePassword">{{ $ut('Change') }}</el-button>
            <el-button plain style="min-width: 8rem" @click="doLogout">{{ $ut('logout') }}</el-button>
        </div>
    </el-form>
</template>

<script>
  Vue.component('ub-change-password', {
    template: '#pwdChangeTpl',

    props: {
      oldPwd: {
        type: String,
        default: ''
      }
    },
    data: function () {
      var validatePass2 = (rule, value, callback) => {
        if (value === '') {
          callback(new Error(this.$ut('EnterNewPassword')))
        } else if (value !== this.changePwd.newPwd) {
          callback(new Error(this.$ut('passwordsDoNotMatch')))
        } else {
          callback()
        }
      }
      return {
        changePwd: {user: this.$UB.connection.userData('login'), oldPwd: this.oldPwd, newPwd: '', newPwd2: '', changedSuccessfully: false},
        changePwdRules : {
          oldPwd: [
            { required: true, message: this.$ut('EnterOldPassword'), trigger: 'blur' }
          ],
          newPwd: [
            { required: true, message: this.$ut('EnterNewPassword'), trigger: 'blur' }
          ],
          newPwd2: [
            { validator: validatePass2, trigger: 'blur' }
          ]
        }
      }
    },
    methods: {
      doChangePassword: function () {
        var me = this
        this.$refs['changePwdForm'].validate(function (valid) {
          if (valid) {
            me.$UB.connection.xhr({
              url: 'changePassword',
              method: 'POST',
              data: {
                newPwd: me.changePwd.newPwd,
                pwd: UB.SHA256('salt' + me.changePwd.oldPwd).toString()
              }
            }).then(function () {
              me.changePwd.changedSuccessfully = true
            })
          } else {
            return false
          }
        })
      },
      doLogout: function () {
        this.$UB.connection.logout()
        window.location.reload()
      }
    }
  })
</script>

<template id="ULoginPageTpl">
  <div id="auth-page" v-loading.fullscreen.lock="loading">
    <div v-if="!loading">
    <el-row>
      <el-col :span="24" class="auth-page__header">{{ $ut('Authentication') }}</el-col>
    </el-row>
    <div class="auth-page__container">
      <div class="auth-page__logo-container">
        <img :src="topLogoURL" class="auth-page__logo">
      </div>
      <hr>
      <div v-if="changePwdActive">
          <ub-change-password :old-pwd="authData.pwd"></ub-change-password>
      </div>
      <div v-else>
      <el-form :model="authData" size="medium" @submit.native.prevent ref="authForm" :rules="authRules">
          <div v-if="hasCERT2()">
              <p class="auth-page__cert-info" v-html="$ut('useCertificateInfoSimple')"></p>
              <el-form-item>
                  <el-button type="secondary" plain style="width: 100%" @click.prevent="fileSelectClick">
                      {{ keyFile ? $ut('Selected key file') + ' ' + keyFile.name : $ut('Select private key file') }}
                  </el-button>
                  <input ref="keyFileInput" type="file" accept=".dat,.pfx,.cnt,.pk8,Key-6.dat,.jks" @change="keyFileChange"/>
              </el-form-item>
              <el-form-item>
                  <el-input :placeholder="$ut('Password')" v-model="authData.pwd" @keyup.enter.native="doCert2Login" type="password" autocomplete="off">
                      <template slot="prepend"><i class="fa fa-fw fa-key"></i></template>
                  </el-input>
              </el-form-item>
              <el-form-item>
                  <el-button type="primary" plain style="min-width: 8rem" @click="doCert2Login">{{ $ut('Enter') }}</el-button>
              </el-form-item>
          </div>

          <div v-if="hasNegotiate()">
              <el-tooltip :content="$ut('KerberosTip')" placement="bottom" effect="light">
                  <i class="auth-page__tooltip fa fa-question-circle-o"></i>
              </el-tooltip>
              <p v-html="$ut('KerberosHeader')"></p>
              <el-form-item>
                  <el-button type="primary" style="min-width: 8rem" @click="doNegotiateLogin">{{ $ut('UBAuthContinue') }}
                  </el-button>
                  <div>
                      <el-switch v-model="silenceKerberosLogin" :active-text="$ut('KerberosRemember')"></el-switch>
                  </div>
              </el-form-item>
              <hr>
          </div>

          <div v-if="hasUB()">
              <el-tooltip :content="$ut('UBAuthTip')" placement="bottom" effect="light">
                  <i class="auth-page__tooltip fa fa-question-circle-o"></i>
              </el-tooltip>
              <p v-html="$ut('UBAuthHeader', appName)"></p>
              <el-form-item></el-form-item>
              <el-form-item prop="user">
                  <el-input autofocus="true" :placeholder="$ut('User')" v-model="authData.user">
                      <template slot="prepend"><i class="fa fa-fw fa-user"></i></template>
                  </el-input>
              </el-form-item>
              <el-form-item prop="pwd">
                  <el-input :placeholder="$ut('Password')" v-model="authData.pwd" @keyup.enter.native="doUBLogin" type="password" autocomplete="off">
                      <template slot="prepend"><i class="fa fa-fw fa-key"></i></template>
                  </el-input>
              </el-form-item>
              <el-form-item>
                  <el-button type="primary" plain style="min-width: 8rem" @click="doUBLogin">{{ $ut('Enter') }}</el-button>
              </el-form-item>
              <div><a href="#">{{ $ut('UBAuthForgotPassword') }}</a></div>
              <div><a href="#">{{ $ut('UBAuthRegistration') }}</a></div>
          </div>
      </el-form>
      </div>
    </div>
    </div>
  </div>
</template>

<div id="app"></div>

<script>
  var vm = new Vue({
    template: '#ULoginPageTpl',

    data: function () {
      return {
        loading: true,
        appName: 'UnityBase',
        topLogoURL: '/models/ub-pub/img/ub-login-logo.png',
        silenceKerberosLogin: window.localStorage.getItem(this.$UB.LDS_KEYS.SILENCE_KERBEROS_LOGIN) === 'true',
        userDidLogout: window.localStorage.getItem(this.$UB.LDS_KEYS.USER_DID_LOGOUT) === 'true',
        authData: {user: '', pwd: ''},
        keyFile: null,
        injectionPromise: Promise.resolve(true),
        changePwdActive: false,
        authRules : {
          user: [
            { required: true, message: this.$ut('blankText'), trigger: 'blur' }
          ],
          pwd: [
            { required: true, message: this.$ut('EnterOldPassword'), trigger: 'blur' }
          ]
        }
      }
    },
    watch: {
      silenceKerberosLogin: function (val) {
        if (val) {
          window.localStorage.setItem(this.$UB.LDS_KEYS.SILENCE_KERBEROS_LOGIN, 'true')
        } else {
          window.localStorage.removeItem(this.$UB.LDS_KEYS.USER_DID_LOGOUT)
        }
      }
    },
    methods: {
      hasNegotiate: function () {
        return !this.hasCERT2() && this.$UB.connection && (this.$UB.connection.authMethods.indexOf('Negotiate') !== -1)
      },
      hasUB: function () {
        return !this.hasCERT2() && this.$UB.connection && (this.$UB.connection.authMethods.indexOf('UB') !== -1)
      },
      hasCERT2: function () {
        return this.$UB.connection && (this.$UB.connection.authMethods.indexOf('CERT2') !== -1)
      },
      fileSelectClick: function () {
        this.$refs['keyFileInput'].click()
      },
      keyFileChange: function (e) {
        this.keyFile = e.target.files[0]
      },
      doNegotiateLogin: function () {
        window.deferred.resolve({
          authSchema: 'Negotiate',
          login: '',
          password: '',
          registration: 0
        })
      },
      doUBLogin: function () {
        var me = this
        this.$refs['authForm'].validate(function (valid) {
          if (valid) {
            window.deferred.resolve({authSchema: 'UB', login: me.authData.user, password: me.authData.pwd})
          } else {
            return false
          }
        })
      },
      doCert2Login: function () {
        var me = this
        if (!me.keyFile) {
          UB.showErrorWindow('Select private key file')
        } else {
          this.injectionPromise.then(function(){
            window.deferred.resolve({
              authSchema: 'CERT2',
              keyFile: me.keyFile,
              password: me.authData.pwd
            })
          })
        }
      }
    }
  })
  vm.$mount('#app')
  window.deferred = {}
  function errorReporter({errMsg, errCode, entityCode, detail}) {
    if (detail) console.error(detail)
    Vue.prototype.$message({
      showClose: true,
      message: errMsg,
      duration: 10000,
      type: 'error'
    })
  }
  UB.setErrorReporter(errorReporter)
  UB.connect({
    host: window.location.origin,
    allowSessionPersistent: true,
    onGotApplicationConfig: function (conn) {
      vm.authMethods = conn.authMethods || []
      let adminUICfg = conn.appConfig.uiSettings.adminUI
      if (adminUICfg.applicationName) {
        let appName = (typeof adminUICfg.applicationName === 'string')
          ? adminUICfg.applicationName
          : adminUICfg.applicationName[conn.preferredLocale]
        if (appName) vm.appName = appName
      }
      if (adminUICfg.loginWindowTopLogoURL) vm.topLogoURL = adminUICfg.loginWindowTopLogoURL
      if (adminUICfg.defaultPasswordForDebugOnly) vm.authData.pwd = adminUICfg.defaultPasswordForDebugOnly
      let lastLogin = localStorage.getItem(UB.LDS_KEYS.LAST_LOGIN)
      if (lastLogin) vm.authData.user = lastLogin
      if (conn.authMethods.indexOf('CERT2') !== -1) {
        let pkiForAuth = conn.appConfig.uiSettings.adminUI.encryptionImplementation
        if (!/clientRequire/.test(pkiForAuth)) {
          pkiForAuth = '/clientRequire/' + pkiForAuth
        }
        let advParam = {
          getCertificates: function () { UB.showErrorWindow('TODO - getCertificates should be implemented') }
        }

        vm.injectionPromise = UB.inject(pkiForAuth).then(function () {
          UA_CRYPT.addEncryptionToConnection(conn, advParam)
          return true
        })
      }
      return UB.inject('/models/ub-pub/locale/lang-' + conn.preferredLocale + '.js').then(function () {
        vm.loading = false
      })
    },
    onCredentialRequired: function (conn, isRepeat) {
      return new Promise(function (resolve, reject) {
        window.deferred.resolve = resolve
        window.deferred.reject = reject
      })
    },
    onNeedChangePassword: function () {
      vm.changePwdActive = true
    },
    onAuthorizationFail: function (reason) {
      UB.showErrorWindow(reason)
    }
  }).then(function authOK (conn) {
    function getUrlVars () {
      var vars = {}
      window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
        vars[key] = value
      })
      return vars
    }
    var returnUrl = getUrlVars()['returnUrl']
    window.location.href = decodeURIComponent(returnUrl)
  })
</script>
</body>
</html>
