module.exports = generateUbqlForUbmSysdictionary

/**
 * @param {object} params
 * @param {SyncConnection} params.conn
 */
function generateUbqlForUbmSysdictionary ({ conn }) {
  console.log('Migration script start: %s', __filename)

  const entity = 'ubm_sysdictionary'

  console.info(
    `  It will update all "${entity}.ubql" attribute from autogenerated ubql using "UB.Repository"`
  )

  console.log(`      Loading entries of ${entity}...`)
  const entries = conn.Repository(entity).attrs('ID', 'code', 'ubql').select()
  console.log(`      ${entries.length} entries`)

  entries.forEach(({ ID, code, ubql }) => {
    if (ubql) {
      console.log('  Skip %s ID=%d (%s), because there is ubql value', entity, ID, code)
      return
    }

    const generatedUbql = JSON.stringify(
      conn.Repository(code).attrs('ID', 'code', 'name').orderBy('name').ubql()
    )

    conn.query({
      entity,
      method: 'update',
      execParams: {
        ID,
        ubql: generatedUbql
      },
      __skipOptimisticLock: true
    })
    console.info('    Set ubql="%s" for "%s"', generatedUbql, code)
  })

  console.log('Migration script finish: %s', __filename)
}
